import fs from "fs";
import path from "path";
import { fileURLToPath, pathToFileURL } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const rootDir = path.resolve(__dirname, "..");
const srcFile = path.resolve(rootDir, "src", "risk-urls.js");
const distDir = path.resolve(rootDir, "dist");
const esmTarget = path.join(distDir, "risk-urls.js");
const cjsTarget = path.join(distDir, "risk-urls.cjs");

if (!fs.existsSync(distDir)) {
  fs.mkdirSync(distDir, { recursive: true });
}

// 保留带注释的 ESM 源
fs.copyFileSync(srcFile, esmTarget);

const moduleUrl = `${pathToFileURL(srcFile).href}?ts=${Date.now()}`;
const mod = await import(moduleUrl);
const candidate = mod.default ?? mod.urls ?? mod;
const urls = Array.isArray(candidate) ? candidate : candidate?.urls;

if (!Array.isArray(urls)) {
  throw new Error("src/risk-urls.js 需导出字符串数组或包含 urls 的对象");
}

const header = "// Auto-generated by scripts/build-risk-urls.js\n";
const cjsBody = `const urls = ${JSON.stringify(urls, null, 2)};

module.exports = urls;
module.exports.urls = urls;
module.exports.default = urls;
`;

fs.writeFileSync(cjsTarget, `${header}${cjsBody}`, "utf8");
